\hypertarget{flash__api_8h}{\section{flash\+\_\+api.\+h File Reference}
\label{flash__api_8h}\index{flash\+\_\+api.\+h@{flash\+\_\+api.\+h}}
}


Code for reading and writing to flash memory directly.  


{\ttfamily \#include $<$avr/io.\+h$>$}\\*
{\ttfamily \#include $<$avr/interrupt.\+h$>$}\\*
{\ttfamily \#include $<$util/atomic.\+h$>$}\\*
{\ttfamily \#include \char`\"{}sp\+\_\+driver.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}eeprom\+\_\+driver.\+h\char`\"{}}\\*
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\hypertarget{flash__api_8h_a4cc14e2c99ae7f8e5a8e371d03c8532c}{\#define {\bfseries F\+L\+A\+S\+H\+\_\+\+P\+A\+G\+E\+\_\+\+S\+I\+Z\+E}~256}\label{flash__api_8h_a4cc14e2c99ae7f8e5a8e371d03c8532c}

\item 
\hypertarget{flash__api_8h_a8f8f8893e9758ea3707f29c05eae3a99}{\#define {\bfseries F\+L\+A\+S\+H\+\_\+\+F\+W\+O\+R\+D\+\_\+\+S\+I\+Z\+E}~9}\label{flash__api_8h_a8f8f8893e9758ea3707f29c05eae3a99}

\item 
\hypertarget{flash__api_8h_afcafe69fcce07e055ef92c2b9cce55a2}{\#define {\bfseries F\+R\+A\+Z\+I\+O\+N\+I\+\_\+\+D\+I\+\_\+\+P\+A\+G\+I\+N\+A\+\_\+\+F\+L\+A\+S\+H}~4}\label{flash__api_8h_afcafe69fcce07e055ef92c2b9cce55a2}

\item 
\hypertarget{flash__api_8h_a44a4aa9445f7f309cf6bc40255322b21}{\#define {\bfseries M\+A\+X\+\_\+\+P\+A\+G\+E\+\_\+\+N\+U\+M\+B\+E\+R}~256}\label{flash__api_8h_a44a4aa9445f7f309cf6bc40255322b21}

\item 
\hypertarget{flash__api_8h_ab83ceaf99dd5feac53724a941d9ed092}{\#define {\bfseries M\+I\+N\+\_\+\+P\+A\+G\+E\+\_\+\+N\+U\+M\+B\+E\+R}~0}\label{flash__api_8h_ab83ceaf99dd5feac53724a941d9ed092}

\item 
\hypertarget{flash__api_8h_af2313420e1599d43885ea5a60c6f3bf7}{\#define {\bfseries I\+M\+X\+\_\+\+M\+A\+X}~20}\label{flash__api_8h_af2313420e1599d43885ea5a60c6f3bf7}

\item 
\hypertarget{flash__api_8h_a0ae5e933c0d2fd294c1daa1a7c3bfcc4}{\#define {\bfseries P\+A\+G\+E\+\_\+\+T\+R\+U\+E}~1}\label{flash__api_8h_a0ae5e933c0d2fd294c1daa1a7c3bfcc4}

\item 
\hypertarget{flash__api_8h_a7716553fc9cecf3bf983c7b0d00a81a2}{\#define {\bfseries P\+A\+G\+E\+\_\+\+F\+A\+L\+S\+E}~0}\label{flash__api_8h_a7716553fc9cecf3bf983c7b0d00a81a2}

\item 
\#define \hyperlink{flash__api_8h_a01b4e293fa536307d215f8b9e9125537}{N\+V\+M\+\_\+\+E\+X\+E\+C}()
\begin{DoxyCompactList}\small\item\em Non-\/\+Volatile Memory Execute Command. \end{DoxyCompactList}\item 
\hypertarget{flash__api_8h_a69a4f657ab8fb68c6a84ae7c25af618c}{\#define {\bfseries X\+B\+\_\+\+S\+U\+C\+C\+E\+S\+S}~0}\label{flash__api_8h_a69a4f657ab8fb68c6a84ae7c25af618c}

\item 
\hypertarget{flash__api_8h_a46c638dfac2ec11f059ab4c34b8ba32f}{\#define {\bfseries X\+B\+\_\+\+E\+R\+R\+\_\+\+N\+O\+\_\+\+A\+P\+I}~1}\label{flash__api_8h_a46c638dfac2ec11f059ab4c34b8ba32f}

\item 
\hypertarget{flash__api_8h_aa09e6db7a1fc5ebeb616f2c7c5dbe6cc}{\#define {\bfseries X\+B\+\_\+\+E\+R\+R\+\_\+\+N\+O\+T\+\_\+\+F\+O\+U\+N\+D}~2}\label{flash__api_8h_aa09e6db7a1fc5ebeb616f2c7c5dbe6cc}

\item 
\hypertarget{flash__api_8h_a2a5e062e2eafdb407f652c6c67d81a58}{\#define {\bfseries X\+B\+\_\+\+I\+N\+V\+A\+L\+I\+D\+\_\+\+A\+D\+D\+R\+E\+S\+S}~3}\label{flash__api_8h_a2a5e062e2eafdb407f652c6c67d81a58}

\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
\hypertarget{flash__api_8h_a6cca46af48cb6fca78462f92bc5367fe}{uint8\+\_\+t {\bfseries F\+L\+A\+S\+H\+\_\+\+Read\+Byte} (uint32\+\_\+t)}\label{flash__api_8h_a6cca46af48cb6fca78462f92bc5367fe}

\item 
void \hyperlink{flash__api_8h_a9b02931ea29c188f0ef99613aea11b1a}{F\+L\+A\+S\+H\+\_\+\+Flush\+Flas\+Page\+Buffer} (void)
\begin{DoxyCompactList}\small\item\em Flush temporary F\+L\+A\+S\+H page buffer. \end{DoxyCompactList}\item 
void \hyperlink{flash__api_8h_a292273938a2318104070bdfa7c986a8f}{F\+L\+A\+S\+H\+\_\+\+Load\+Flash\+Page\+Buffer} (const uint8\+\_\+t $\ast$)
\begin{DoxyCompactList}\small\item\em Load entire page into temporary F\+L\+A\+S\+H page buffer. \end{DoxyCompactList}\item 
void \hyperlink{flash__api_8h_afd76fa9f7b193e4ca19fd445b15cc3e5}{F\+L\+A\+S\+H\+\_\+\+Erase\+Application\+Sections} (void)
\begin{DoxyCompactList}\small\item\em Erase entire application section. \end{DoxyCompactList}\item 
void \hyperlink{flash__api_8h_ac5fc05366ec85b0edd3e8ffb1e1b4f6d}{F\+L\+A\+S\+H\+\_\+\+Erase\+Write\+Application\+Page} (uint16\+\_\+t)
\begin{DoxyCompactList}\small\item\em Erase and write page buffer to application or application table section at byte address. \end{DoxyCompactList}\item 
\hypertarget{flash__api_8h_a82de2ed9a02c5051cdcd8bccc74a9caf}{uint32\+\_\+t {\bfseries F\+L\+A\+S\+H\+\_\+\+Application\+C\+R\+C} (void)}\label{flash__api_8h_a82de2ed9a02c5051cdcd8bccc74a9caf}

\item 
\hypertarget{flash__api_8h_ad6c647ec522bbd157036a324c24e0576}{uint32\+\_\+t {\bfseries F\+L\+A\+S\+H\+\_\+\+Range\+C\+R\+C} (uint32\+\_\+t, uint32\+\_\+t)}\label{flash__api_8h_ad6c647ec522bbd157036a324c24e0576}

\item 
void \hyperlink{flash__api_8h_a1d40b4918668438b6e2ad9875f42a644}{F\+L\+A\+S\+H\+\_\+\+Wait\+For\+N\+V\+M} (void)
\begin{DoxyCompactList}\small\item\em Read a byte from flash. \end{DoxyCompactList}\item 
\hypertarget{flash__api_8h_a1b553fc6c28d8299cc52fa2e5c59f788}{void {\bfseries F\+L\+A\+S\+H\+\_\+\+Read\+Flash\+Page} (uint8\+\_\+t $\ast$, uint32\+\_\+t)}\label{flash__api_8h_a1b553fc6c28d8299cc52fa2e5c59f788}

\item 
\hypertarget{flash__api_8h_a3407b653ba717c0c4f254a786d155f14}{uint16\+\_\+t {\bfseries binary\+\_\+search} (uint16\+\_\+t, uint16\+\_\+t)}\label{flash__api_8h_a3407b653ba717c0c4f254a786d155f14}

\item 
\hypertarget{flash__api_8h_a7d7fb01011463eee9f4ec871b95ca179}{uint16\+\_\+t {\bfseries flash\+\_\+compare} (uint32\+\_\+t)}\label{flash__api_8h_a7d7fb01011463eee9f4ec871b95ca179}

\item 
\hypertarget{flash__api_8h_a5dc8212e11680c8126d3d3f449cf34bd}{uint16\+\_\+t {\bfseries midpoint} (uint16\+\_\+t, uint16\+\_\+t)}\label{flash__api_8h_a5dc8212e11680c8126d3d3f449cf34bd}

\item 
\hypertarget{flash__api_8h_a96dcf972e04bc4780aaf168db7f32145}{uint8\+\_\+t {\bfseries write\+\_\+user\+\_\+signature\+\_\+row} (uint8\+\_\+t $\ast$data)}\label{flash__api_8h_a96dcf972e04bc4780aaf168db7f32145}

\item 
\hypertarget{flash__api_8h_a8c1ca227c7d726bb6ff3b3048ccd08dd}{uint8\+\_\+t {\bfseries read\+\_\+user\+\_\+signature\+\_\+byte} (uint16\+\_\+t index)}\label{flash__api_8h_a8c1ca227c7d726bb6ff3b3048ccd08dd}

\item 
\hypertarget{flash__api_8h_a6199ae35998af457460cf62641265bcd}{void {\bfseries load\+\_\+flash\+\_\+page} (const uint8\+\_\+t $\ast$data)}\label{flash__api_8h_a6199ae35998af457460cf62641265bcd}

\item 
\hypertarget{flash__api_8h_a3d8d56003796122d2328b93ec0dc7f0a}{void {\bfseries erase\+\_\+write\+\_\+application\+\_\+page} (uint32\+\_\+t address)}\label{flash__api_8h_a3d8d56003796122d2328b93ec0dc7f0a}

\item 
\hypertarget{flash__api_8h_a83303850a223e7543867c2c0dc2d0be0}{void {\bfseries erase\+\_\+flash\+\_\+buffer} ()}\label{flash__api_8h_a83303850a223e7543867c2c0dc2d0be0}

\item 
\hypertarget{flash__api_8h_abb078106c6f1192f3e338206d1aa5447}{void {\bfseries read\+\_\+flash\+\_\+page} (const uint8\+\_\+t $\ast$data, uint32\+\_\+t address)}\label{flash__api_8h_abb078106c6f1192f3e338206d1aa5447}

\item 
\hypertarget{flash__api_8h_a4beb81a90014f5507d1bf7b7228cae44}{void {\bfseries erase\+\_\+application\+\_\+page} (uint32\+\_\+t address)}\label{flash__api_8h_a4beb81a90014f5507d1bf7b7228cae44}

\end{DoxyCompactItemize}


\subsection{Detailed Description}
Code for reading and writing to flash memory directly. 

This file largely derived from the \href{https://github.com/alexforencich/xboot}{\tt xboot} project, on Git\+Hub. 

Definition in file \hyperlink{flash__api_8h_source}{flash\+\_\+api.\+h}.



\subsection{Macro Definition Documentation}
\hypertarget{flash__api_8h_a01b4e293fa536307d215f8b9e9125537}{\index{flash\+\_\+api.\+h@{flash\+\_\+api.\+h}!N\+V\+M\+\_\+\+E\+X\+E\+C@{N\+V\+M\+\_\+\+E\+X\+E\+C}}
\index{N\+V\+M\+\_\+\+E\+X\+E\+C@{N\+V\+M\+\_\+\+E\+X\+E\+C}!flash\+\_\+api.\+h@{flash\+\_\+api.\+h}}
\subsubsection[{N\+V\+M\+\_\+\+E\+X\+E\+C}]{\setlength{\rightskip}{0pt plus 5cm}\#define N\+V\+M\+\_\+\+E\+X\+E\+C(
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)}}\label{flash__api_8h_a01b4e293fa536307d215f8b9e9125537}
{\bfseries Value\+:}
\begin{DoxyCode}
\textcolor{keyword}{asm}(\textcolor{stringliteral}{"push r30"}      \textcolor{stringliteral}{"\(\backslash\)n\(\backslash\)t"}  \(\backslash\)
                        \textcolor{stringliteral}{"push r31"}      \textcolor{stringliteral}{"\(\backslash\)n\(\backslash\)t"}  \(\backslash\)
                        \textcolor{stringliteral}{"push r16"}      \textcolor{stringliteral}{"\(\backslash\)n\(\backslash\)t"}  \(\backslash\)
                        \textcolor{stringliteral}{"push r18"}      \textcolor{stringliteral}{"\(\backslash\)n\(\backslash\)t"}  \(\backslash\)
                        \textcolor{stringliteral}{"ldi r30, 0xCB"} \textcolor{stringliteral}{"\(\backslash\)n\(\backslash\)t"}  \(\backslash\)
                        \textcolor{stringliteral}{"ldi r31, 0x01"} \textcolor{stringliteral}{"\(\backslash\)n\(\backslash\)t"}  \(\backslash\)
                        \textcolor{stringliteral}{"ldi r16, 0xD8"} \textcolor{stringliteral}{"\(\backslash\)n\(\backslash\)t"}  \(\backslash\)
                        \textcolor{stringliteral}{"ldi r18, 0x01"} \textcolor{stringliteral}{"\(\backslash\)n\(\backslash\)t"}  \(\backslash\)
                        \textcolor{stringliteral}{"out 0x34, r16"} \textcolor{stringliteral}{"\(\backslash\)n\(\backslash\)t"}  \(\backslash\)
                        \textcolor{stringliteral}{"st Z, r18"}     \textcolor{stringliteral}{"\(\backslash\)n\(\backslash\)t"}  \(\backslash\)
                        \textcolor{stringliteral}{"pop r18"}       \textcolor{stringliteral}{"\(\backslash\)n\(\backslash\)t"}  \(\backslash\)
                        \textcolor{stringliteral}{"pop r16"}       \textcolor{stringliteral}{"\(\backslash\)n\(\backslash\)t"}  \(\backslash\)
                        \textcolor{stringliteral}{"pop r31"}       \textcolor{stringliteral}{"\(\backslash\)n\(\backslash\)t"}  \(\backslash\)
                        \textcolor{stringliteral}{"pop r30"}       \textcolor{stringliteral}{"\(\backslash\)n\(\backslash\)t"}  \(\backslash\)
                       )
\end{DoxyCode}


Non-\/\+Volatile Memory Execute Command. 

This macro set the C\+C\+P register before setting the C\+M\+D\+E\+X bit in the N\+V\+M.\+C\+T\+R\+L\+A register.

\begin{DoxyNote}{Note}
The C\+M\+D\+E\+X bit must be set within 4 clock cycles after setting the protection byte in the C\+C\+P register. 
\end{DoxyNote}


Definition at line 40 of file flash\+\_\+api.\+h.



\subsection{Function Documentation}
\hypertarget{flash__api_8h_afd76fa9f7b193e4ca19fd445b15cc3e5}{\index{flash\+\_\+api.\+h@{flash\+\_\+api.\+h}!F\+L\+A\+S\+H\+\_\+\+Erase\+Application\+Sections@{F\+L\+A\+S\+H\+\_\+\+Erase\+Application\+Sections}}
\index{F\+L\+A\+S\+H\+\_\+\+Erase\+Application\+Sections@{F\+L\+A\+S\+H\+\_\+\+Erase\+Application\+Sections}!flash\+\_\+api.\+h@{flash\+\_\+api.\+h}}
\subsubsection[{F\+L\+A\+S\+H\+\_\+\+Erase\+Application\+Sections}]{\setlength{\rightskip}{0pt plus 5cm}void F\+L\+A\+S\+H\+\_\+\+Erase\+Application\+Sections (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}}\label{flash__api_8h_afd76fa9f7b193e4ca19fd445b15cc3e5}


Erase entire application section. 

This function erases the entire application and application table section

\begin{DoxyNote}{Note}
If the lock bits is set to not allow spm in the application or application table section the erase is not done. 
\end{DoxyNote}


Definition at line 59 of file flash\+\_\+api.\+c.

\hypertarget{flash__api_8h_ac5fc05366ec85b0edd3e8ffb1e1b4f6d}{\index{flash\+\_\+api.\+h@{flash\+\_\+api.\+h}!F\+L\+A\+S\+H\+\_\+\+Erase\+Write\+Application\+Page@{F\+L\+A\+S\+H\+\_\+\+Erase\+Write\+Application\+Page}}
\index{F\+L\+A\+S\+H\+\_\+\+Erase\+Write\+Application\+Page@{F\+L\+A\+S\+H\+\_\+\+Erase\+Write\+Application\+Page}!flash\+\_\+api.\+h@{flash\+\_\+api.\+h}}
\subsubsection[{F\+L\+A\+S\+H\+\_\+\+Erase\+Write\+Application\+Page}]{\setlength{\rightskip}{0pt plus 5cm}void F\+L\+A\+S\+H\+\_\+\+Erase\+Write\+Application\+Page (
\begin{DoxyParamCaption}
\item[{uint16\+\_\+t}]{page\+\_\+number}
\end{DoxyParamCaption}
)}}\label{flash__api_8h_ac5fc05366ec85b0edd3e8ffb1e1b4f6d}


Erase and write page buffer to application or application table section at byte address. 

This function does a combined erase and write to a flash page in the application or application table section.


\begin{DoxyParams}{Parameters}
{\em page\+\_\+number} & Flash page number. \\
\hline
\end{DoxyParams}


Definition at line 79 of file flash\+\_\+api.\+c.

\hypertarget{flash__api_8h_a9b02931ea29c188f0ef99613aea11b1a}{\index{flash\+\_\+api.\+h@{flash\+\_\+api.\+h}!F\+L\+A\+S\+H\+\_\+\+Flush\+Flas\+Page\+Buffer@{F\+L\+A\+S\+H\+\_\+\+Flush\+Flas\+Page\+Buffer}}
\index{F\+L\+A\+S\+H\+\_\+\+Flush\+Flas\+Page\+Buffer@{F\+L\+A\+S\+H\+\_\+\+Flush\+Flas\+Page\+Buffer}!flash\+\_\+api.\+h@{flash\+\_\+api.\+h}}
\subsubsection[{F\+L\+A\+S\+H\+\_\+\+Flush\+Flas\+Page\+Buffer}]{\setlength{\rightskip}{0pt plus 5cm}void F\+L\+A\+S\+H\+\_\+\+Flush\+Flas\+Page\+Buffer (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}}\label{flash__api_8h_a9b02931ea29c188f0ef99613aea11b1a}


Flush temporary F\+L\+A\+S\+H page buffer. 

This function flushes the F\+L\+A\+S\+H page buffers. 

Definition at line 8 of file flash\+\_\+api.\+c.

\hypertarget{flash__api_8h_a292273938a2318104070bdfa7c986a8f}{\index{flash\+\_\+api.\+h@{flash\+\_\+api.\+h}!F\+L\+A\+S\+H\+\_\+\+Load\+Flash\+Page\+Buffer@{F\+L\+A\+S\+H\+\_\+\+Load\+Flash\+Page\+Buffer}}
\index{F\+L\+A\+S\+H\+\_\+\+Load\+Flash\+Page\+Buffer@{F\+L\+A\+S\+H\+\_\+\+Load\+Flash\+Page\+Buffer}!flash\+\_\+api.\+h@{flash\+\_\+api.\+h}}
\subsubsection[{F\+L\+A\+S\+H\+\_\+\+Load\+Flash\+Page\+Buffer}]{\setlength{\rightskip}{0pt plus 5cm}void F\+L\+A\+S\+H\+\_\+\+Load\+Flash\+Page\+Buffer (
\begin{DoxyParamCaption}
\item[{const uint8\+\_\+t $\ast$}]{ram\+\_\+buffer\+\_\+ptr}
\end{DoxyParamCaption}
)}}\label{flash__api_8h_a292273938a2318104070bdfa7c986a8f}


Load entire page into temporary F\+L\+A\+S\+H page buffer. 

This function loads an entire F\+L\+A\+S\+H page from an S\+R\+A\+M buffer to the F\+L\+A\+S\+H page buffers. Make sure that the buffer is flushed before starting to load bytes.

\begin{DoxyNote}{Note}
Only the lower part of the address is used to address the buffer. Therefore, no address parameter is needed. In the end, the data is written to the F\+L\+A\+S\+H page given by the address parameter to the F\+L\+A\+S\+H write page operation.
\end{DoxyNote}

\begin{DoxyParams}{Parameters}
{\em values} & Pointer to S\+R\+A\+M buffer containing an entire page. \\
\hline
\end{DoxyParams}


Definition at line 30 of file flash\+\_\+api.\+c.

\hypertarget{flash__api_8h_a1d40b4918668438b6e2ad9875f42a644}{\index{flash\+\_\+api.\+h@{flash\+\_\+api.\+h}!F\+L\+A\+S\+H\+\_\+\+Wait\+For\+N\+V\+M@{F\+L\+A\+S\+H\+\_\+\+Wait\+For\+N\+V\+M}}
\index{F\+L\+A\+S\+H\+\_\+\+Wait\+For\+N\+V\+M@{F\+L\+A\+S\+H\+\_\+\+Wait\+For\+N\+V\+M}!flash\+\_\+api.\+h@{flash\+\_\+api.\+h}}
\subsubsection[{F\+L\+A\+S\+H\+\_\+\+Wait\+For\+N\+V\+M}]{\setlength{\rightskip}{0pt plus 5cm}void F\+L\+A\+S\+H\+\_\+\+Wait\+For\+N\+V\+M (
\begin{DoxyParamCaption}
\item[{void}]{}
\end{DoxyParamCaption}
)}}\label{flash__api_8h_a1d40b4918668438b6e2ad9875f42a644}


Read a byte from flash. 

This function reads one byte from the flash.

\begin{DoxyNote}{Note}
Both I\+A\+R and G\+C\+C have functions to do this, but we include the fucntions for easier use.
\end{DoxyNote}

\begin{DoxyParams}{Parameters}
{\em address} & Address to the location of the byte to read.\\
\hline
\end{DoxyParams}

\begin{DoxyRetVals}{Return values}
{\em Byte} & read from flash.\\
\hline
\end{DoxyRetVals}
Wait for any N\+V\+M access to finish, including F\+L\+A\+S\+H.

This function is blocking and waits for any N\+V\+M access to finish, including F\+L\+A\+S\+H. Use this function before any F\+L\+S\+H accesses, if you are not certain that any previous operations are finished yet, like an F\+L\+A\+S\+H write. 

Definition at line 125 of file flash\+\_\+api.\+c.

